# Lua模块管理工具说明文档

## 1. 项目概述
- **目录**：./tools/luaModule
本目录包含两个主要部分：
- **Lua模块文件**：用于MediaWiki的Lua脚本模块，存储在`./tools/luaModule/modules`目录中
- **Wiki同步工具**：`wiki_sync.py`脚本，用于在本地文件系统和MediaWiki之间同步Lua模块

## 2. Wiki同步工具（wiki_sync.py）

### 2.1 功能介绍

`wiki_sync.py`是一个Python脚本工具，用于在本地文件系统和MediaWiki之间双向同步Lua模块页面。主要功能包括：

- **从Wiki拉取模块**：将Wiki上所有"模块:"命名空间的页面下载到本地文件系统
- **向Wiki推送模块**：将本地修改的模块文件上传到Wiki对应页面
- **支持通配符过滤**：可以通过`--pattern`参数指定要推送的特定文件
- **自动处理页面名称与文件名转换**：处理特殊字符（空格、斜杠等）的转换

### 2.2 使用方法

#### 2.2.1 拉取所有模块页面

```bash
python wiki_sync.py pull
```

此命令会将Wiki上所有"模块:"命名空间的页面下载到`./tools/luaModule/modules`目录中。

#### 2.2.2 推送所有模块文件

```bash
python wiki_sync.py push
```

此命令会将`./tools/luaModule/modules`目录中的所有Lua文件上传到Wiki对应的"模块:"页面。

#### 2.2.3 推送特定模块文件

```bash
python wiki_sync.py push --pattern "测试*.lua"
```

使用`--pattern`参数可以指定要推送的特定文件，支持通配符模式。

### 2.3 页面名称与文件名转换规则

为了处理Wiki页面名称中的特殊字符，本工具使用以下转换规则：

#### 2.3.1 页面名称 → 文件名

- **命名空间**：移除"模块:"命名空间前缀
- **空格**：将空格转换为单下划线 `_`
- **斜杠**：将斜杠 `/` 转换为 `@` 符号
- **扩展名**：Lua模块文件使用`.lua`扩展名，文档页面使用`.wikitext`扩展名

**示例**：
- "模块:Museum wings" → `Museum_wings.lua`
- "模块:Module/Get/Utils" → `Module@Get@Utils.lua`
- "模块:Get/doc" → `Get@doc.wikitext`

#### 2.3.2 文件名 → 页面名称

- **添加命名空间**：为文件名添加"模块:"命名空间前缀
- **恢复斜杠**：将`@`符号转换回斜杠 `/`
- **移除扩展名**：移除`.lua`或`.wikitext`扩展名

**注意**：由于无法在反向转换时区分原始下划线和空格转换的下划线，因此对于包含空格的页面名称，转换在从页面到文件时是单向的。

## 3. Lua模块开发指南

### 3.1 模块路径

所有Lua模块文件应存储在：`./tools/luaModule/modules`

### 3.2 语法要求

- 符合MediaWiki的Lua模块语法规范
- 符合Lua编程语言语法

### 3.3 数据读取方式

- 模块在Wiki环境中运行时，数据从Wiki系统中读取，而不是从本地文件系统读取
- 本地开发时，可通过wiki_sync工具同步到Wiki进行测试

### 3.4 函数命名规范

```lua
-- 用于传入参数不是frame的模块内部函数
-- 通常用于各个模块之间快速的数据处理
p._privateFunction = function()
    -- 函数实现
end

-- 用于传入参数是frame的对外函数
-- 通常用于主空间页面调用模块的使用
p.publicFunction = function(frame)
    -- 函数实现
end
```

### 3.5 错误处理原则

在没有明确的要求时，不需要对数据类型进行判断再兼容的处理，报错更方便使用者进行数据定位

### 3.6 代码复用

尽量使用已有的功能函数：
- MediaWiki提供的模块功能函数
- Lua自带的功能函数

### 3.7 内置辅助模块

可以使用一些预先内置的模块协助开发：

| 模块文件 | 用途 | 可修改性 |
|----------|------|----------|
| Get.lua | 提供数据获取功能 | 不可修改 |
| Fun.lua | 提供通用函数库 | 不可修改 |
| Custom.lua | 提供自定义功能 | 可更新 |
| Utils.lua | 提供工具函数 | 可更新 |

## 4. 开发工作流程

1. **拉取现有模块**：使用`python wiki_sync.py pull`获取最新的Wiki模块
2. **本地修改**：在`./modules`目录中编辑或创建Lua模块文件
3. **测试**：使用`python wiki_sync.py push`将修改推送到Wiki进行测试
4. **特定文件推送**：可使用`--pattern`参数仅推送需要更新的文件

## 5. 注意事项

- 在编辑模块前，建议先拉取最新版本，避免冲突
- 对于包含空格的页面名称，请注意转换的单向性
- 推送前请确保代码符合语法规范，避免推送有错误的代码
- Fun.lua和Get.lua模块不可修改，请使用其他方式扩展功能